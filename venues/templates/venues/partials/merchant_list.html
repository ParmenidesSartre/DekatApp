{% for merchant in merchants %}
<div class="bg-white rounded-3xl p-4 shadow-card border border-gray-100 hover:scale-[1.02] transition-transform duration-200 animate-[fadeIn_0.3s_ease-out]">
    {% if merchant.is_featured %}
    <div class="mb-3 flex">
        <span class="bg-orange-100 text-orange-700 text-[10px] font-extrabold px-3 py-1 rounded-full flex items-center gap-1 border border-orange-200">
            <i class="fa-solid fa-sparkles"></i> Pilihan Ramai
        </span>
    </div>
    {% endif %}

    <div class="flex gap-4 items-start">
        <div class="w-16 h-16 shrink-0 rounded-2xl bg-gray-50 border border-gray-200 flex items-center justify-center p-2 overflow-hidden">
            {% if merchant.logo %}
                <img src="{{ merchant.logo.url }}" class="w-full h-full object-contain" alt="{{ merchant.name }}">
            {% else %}
                <span class="text-2xl text-gray-300"><i class="fa-solid fa-store"></i></span>
            {% endif %}
        </div>

        <div class="flex-1 min-w-0">
            <div class="flex justify-between items-start gap-3">
                <a href="{% url 'merchant_detail' merchant.floor.venue.slug merchant.id %}" class="font-display font-bold text-lg text-gray-900 truncate leading-tight hover:underline">
                    {{ merchant.name }}
                </a>
                <div class="flex items-center gap-2 shrink-0">
                    {% if merchant.id in open_ids %}
                    <span class="bg-emerald-100 text-emerald-800 text-[10px] font-extrabold px-2 py-1 rounded-lg border border-emerald-200">
                        Open now
                    </span>
                    {% endif %}
                    <span class="bg-gray-100 text-gray-600 text-[10px] font-bold px-2 py-1 rounded-lg">
                        {{ merchant.floor.name }}
                    </span>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-2 mt-2">
                {% if merchant.lot_number %}
                <span class="text-indigo-700 font-bold text-xs bg-pop-blue/40 px-3 py-1.5 rounded-xl border-2 border-white flex items-center gap-1">
                    <i class="fa-solid fa-door-open"></i> {{ merchant.lot_number }}
                </span>
                {% endif %}

                {% if merchant.is_halal %}
                <span class="text-white font-bold text-[10px] bg-halal px-2 py-1 rounded-md flex items-center gap-1 shadow-sm">
                    <i class="fa-solid fa-check"></i> Halal
                </span>
                {% endif %}

                {% if merchant.accepts_ewallet %}
                <span class="text-slate-700 font-bold text-[10px] bg-pop-lime/40 px-2 py-1 rounded-xl border-2 border-white flex items-center gap-1">
                    <i class="fa-solid fa-wallet text-emerald-600"></i> E-Wallet
                </span>
                {% endif %}
            </div>

            <div class="mt-3 flex items-center gap-2">
                {% if merchant.id in followed_ids %}
                    {% include "venues/partials/follow_button.html" with merchant=merchant is_following=True %}
                {% else %}
                    {% include "venues/partials/follow_button.html" with merchant=merchant is_following=False %}
                {% endif %}
                <a href="{% url 'merchant_updates' merchant.floor.venue.slug merchant.id %}" class="bg-white text-gray-700 border border-gray-200 font-display font-bold text-xs px-3 py-2 rounded-2xl shadow-sm hover:shadow-md transition-all inline-flex items-center gap-2">
                    <i class="fa-solid fa-bolt"></i> Updates
                </a>
            </div>
        </div>
    </div>

    <details class="group mt-4 border-t border-gray-100 pt-3">
        <summary class="flex items-center justify-between text-sm font-bold text-gray-500 cursor-pointer select-none">
            <span>Info cepat</span>
            <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center group-open:bg-brand-main group-open:text-white transition-colors">
                <i class="fa-solid fa-chevron-down text-xs transition-transform group-open:rotate-180"></i>
            </div>
        </summary>

        <div class="pt-4">
            {% if merchant.nearest_entrance %}
            <div class="flex items-center gap-2 text-sm text-gray-600 mb-3 bg-gray-50 p-2 rounded-lg">
                <i class="fa-solid fa-location-dot text-gray-400"></i>
                <span class="font-medium">{{ merchant.nearest_entrance }}</span>
            </div>
            {% endif %}

            {% if merchant.operating_hours %}
            <div class="flex items-center gap-2 text-sm text-gray-600 mb-3 bg-gray-50 p-2 rounded-lg">
                <i class="fa-regular fa-clock text-gray-400"></i>
                <span class="font-medium">{{ merchant.operating_hours }}</span>
            </div>
            {% endif %}

            {% if merchant.storefront_image %}
            <div class="mb-4 overflow-hidden rounded-2xl border border-gray-100 bg-gray-50">
                <img src="{{ merchant.storefront_image.url }}" alt="{{ merchant.name }}" class="w-full h-40 object-cover">
            </div>
            {% endif %}

            {% if merchant.description %}
            <p class="text-sm text-gray-600 leading-relaxed mb-4">{{ merchant.description }}</p>
            {% endif %}

            <div class="grid grid-cols-2 gap-3">
                {% if merchant.phone_number %}
                <a href="tel:{{ merchant.phone_number }}" class="flex items-center justify-center gap-2 py-3 rounded-xl bg-[#25D366] text-white font-bold text-sm shadow-md hover:bg-[#20bd5a] transition-colors">
                    <i class="fa-brands fa-whatsapp text-lg"></i> WhatsApp
                </a>
                {% else %}
                <a href="{% url 'merchant_detail' merchant.floor.venue.slug merchant.id %}" class="flex items-center justify-center gap-2 py-3 rounded-xl bg-gray-100 text-gray-700 font-bold text-sm border border-gray-200 hover:bg-gray-50 transition-colors">
                    <i class="fa-solid fa-circle-info"></i> Details
                </a>
                {% endif %}

                {% if merchant.instagram %}
                <a href="{{ merchant.instagram }}" target="_blank" class="flex items-center justify-center gap-2 py-3 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold text-sm shadow-md">
                    <i class="fa-brands fa-instagram text-lg"></i> Instagram
                </a>
                {% elif merchant.website %}
                <a href="{{ merchant.website }}" target="_blank" class="flex items-center justify-center gap-2 py-3 rounded-xl bg-brand-main text-white font-bold text-sm shadow-md hover:bg-brand-dark transition-colors">
                    <i class="fa-solid fa-globe"></i> Website
                </a>
                {% else %}
                <a href="{% url 'merchant_detail' merchant.floor.venue.slug merchant.id %}" class="flex items-center justify-center gap-2 py-3 rounded-xl bg-brand-main text-white font-bold text-sm shadow-md hover:bg-brand-dark transition-colors">
                    <i class="fa-solid fa-arrow-right"></i> More
                </a>
                {% endif %}
            </div>
        </div>
    </details>
</div>
{% endfor %}

{% if merchants.has_next %}
<div id="load-more-container" class="text-center pt-6 pb-2 col-span-full">
    <button
        hx-get="?page={{ merchants.next_page_number }}&q={{ search_query }}{% if current_category %}&category={{ current_category }}{% endif %}"
        hx-trigger="click"
        hx-target="#load-more-container"
        hx-swap="outerHTML"
        class="bg-white text-brand-main font-display font-bold py-3 px-8 rounded-full shadow-md border-2 border-brand-main hover:bg-brand-main hover:text-white hover:shadow-lg transition-all transform active:scale-95 flex items-center gap-2 mx-auto">
        <span>Muat lagi ({{ merchants.next_page_number }})</span>
        <i class="fa-solid fa-arrow-down"></i>
    </button>
</div>
{% endif %}
